#!/bin/bash

TYPE=$1
NAME=$2
STATE=$3
INSTANCE_ID=`ec2metadata --instance-id`
INTERFACEATTACHID=`/usr/local/bin/aws ec2 describe-network-interfaces --network-interface-ids {{ aws_netint_id }} |grep AttachmentId |awk '{print $2}'|/bin/rev|/bin/cut -c 2-|/bin/rev|cut -d '"' -f 2`

case $STATE in
    "MASTER") sudo /usr/local/bin/aws ec2 attach-network-interface --instance-id $INSTANCEID --network-interface-id {{ aws_netint_id }} --device-index 1 ; sleep 10 ; sudo /sbin/ifup {{ sec_net_int }}
        exit 0
        ;;
    "BACKUP") sudo /sbin/ifdown {{ sec_net_int }} ; /usr/local/bin/aws ec2 detach-network-interface --attachment-id $INTERFACEATTACHID`
        exit 0
        ;;
    "FAULT")  sudo /sbin/ifdown {{ sec_net_int }} ; /usr/local/bin/aws ec2 detach-network-interface --attachment-id $INTERFACEATTACHID`
        exit 0
        ;;
    *)        echo "unknown state"
        exit 1
        ;;
esac